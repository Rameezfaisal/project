Cell 6 — Remove Non-Preferred Suppliers when Duplicate NHAs Exist

What this step does in business terms
After combining Info Records + EORD, some NHAs may still appear with multiple supplier rows
(because SAP allows more than one valid source per part).
However, OMAT must keep only the “best” supplier per NHA per plant.
This step answers:
“If multiple suppliers exist for the same NHA, which one is NOT the official fixed vendor?”








# detect duplicate NHAs
w = Window.partitionBy("nha")

df_dups = (
    spark.table("stage2_eord_filled")
    .withColumn("dup_cnt", F.count("*").over(w))
    .filter(F.col("dup_cnt") > 1)
    .select("nha")
    .distinct()
)

df_dups.createOrReplaceTempView("dup_nha")

# bring EORD back to mark fixed vs non-fixed suppliers
df_eord_flag = (
    df_eord
    .select(
        F.col("matnr_cd").alias("nha"),
        F.col("werks_cd"),
        F.col("lifnr_cd"),
        F.col("flifn_cd"),
        F.col("autet_cd")
    )
)

base = spark.table("stage2_eord_filled")

def remove_non_fixed(df, plant):
    return (
        df.join(
            df_eord_flag,
            (df.nha == df_eord_flag.nha) &
            (df_eord_flag.werks_cd == plant) &
            (df_eord_flag.lifnr_cd == df[f"suppcd_{plant}"]),
            "left"
        )
        .filter(
            ~(
                (F.col("nha").isin([r.nha for r in df_dups.collect()])) &
                (F.col("flifn_cd") != preferred_flag) &
                (F.col("autet_cd").isNotNull())
            )
        )
        .drop("werks_cd","lifnr_cd","flifn_cd","autet_cd")
    )

df_clean = base
for plant in procurement_plants:
    df_clean = remove_non_fixed(df_clean, plant)

df_clean.createOrReplaceTempView("stage3_deduped")

