final_dtls.write.insertInto(tgt_dtls)




Step 8 â€” Historical Consumption
What it does (business)
Calculates how much of each RSCXD part has been used in the past from SAP demand history.
This shows part criticality based on real usage.





partcons = (
    spark.table(tgt_dtls).alias("a")
    .join(dmd_df.alias("b"), F.col("a.nha") == F.col("b.hostpartid"))
    .filter(F.col("b.ordertype").isin("TA","ZCON","ZO09","ZO04","ZSD","ZSO","ZFO","ZUP"))
    .groupBy("a.nha")
    .agg(F.sum("b.historyamount").cast("int").alias("sprs_cons"))
)




