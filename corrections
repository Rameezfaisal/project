Cell 7 — Close OBPR-Part Records Removed from iPLM
Business Purpose:
If an OBPR–Part combination no longer exists in the iPLM obsolete component list, it means the part was removed from that PR.
Such records must be marked as CLOSED in OMAT.







active_iplm_keys_df = (
    iplm_obsolete_df
    .select(
        F.col("obprno_key").alias("obprno_key_chk"),
        F.col("obprtno_key").alias("obprtno_key_chk")
    )
    .dropDuplicates()
)






target_df = spark.table(tgt_obprtno_dtls_tbl) \
    .select(
        F.col("obprno").alias("t_obprno"),
        F.col("obprtno").alias("t_obprtno")
    )

removed_pairs_df = (
    target_df.alias("t")
    .join(
        active_iplm_keys_df.alias("s"),
        (F.col("t.t_obprno") == F.col("s.obprno_key_chk")) &
        (F.col("t.t_obprtno") == F.col("s.obprtno_key_chk")),
        "left_anti"
    )
)








(
    obprtno_delta.alias("t")
    .merge(
        removed_pairs_df.alias("r"),
        "t.obprno = r.t_obprno AND t.obprtno = r.t_obprtno"
    )
    .whenMatchedUpdate(set={
        "obpr_state": f"'{closed_state}'",
        "last_modified_on": "current_timestamp()"
    })
    .execute()
)