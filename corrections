# --- CELL 5: WRITE, CONFIGURE & OPTIMIZE ---

# 1. WRITE THE TABLE FIRST (Creates it if missing)
print(f"Writing Gold Table to: {T_GOLD_ANALYSIS} ...")

df_gold.write \
    .format("delta") \
    .mode("overwrite") \
    .option("overwriteSchema", "true") \
    .saveAsTable(T_GOLD_ANALYSIS)

print("Write completed. Now configuring optimizations...")

# 2. Update Table Properties
# Now that the table definitely exists, we can modify its properties.
spark.sql(f"""
    ALTER TABLE {T_GOLD_ANALYSIS} 
    SET TBLPROPERTIES ('delta.dataSkippingNumIndexedCols' = '200')
""")

# 3. Run Optimize
print(f"Starting Z-Order Optimization on {T_GOLD_ANALYSIS}...")
spark.sql(f"OPTIMIZE {T_GOLD_ANALYSIS} ZORDER BY (Order, Part, CreationDate)")

print("Optimization completed. Table is ready for Power BI.")
