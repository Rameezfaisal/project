CELL 8 â€” OB Part Supplier (Primary OB Supplier Logic)
ðŸ§  Business Meaning
This block captures:
OB Parts where the component itself is the NHA
and we pull the primary (OB) supplier + current inventory position
These are the main suppliers responsible for the obsolescence part.
This corresponds to the FIRST SELECT block in SAP before all the UNIONs.
ðŸ“Œ What we derive here
For each OB Part:
Supplier (preferred/OB supplier)
On-hand stock (LAMQOH)
Open PO quantity
LTB info (if exists)
Refresh scheduling fields







from pyspark.sql import functions as F

# Filter only valid OBPR states
ob_base_df = obprt_df.filter(F.col("obpr_state").isin(valid_states))

# OB Supplier = where CMPPRTNO = NHA
ob_supplier_df = ob_base_df.alias("o") \
    .join(
        dmd_df.alias("d"),
        (F.col("o.obprtno") == F.col("d.cmpprtno_dmd")) &
        (F.col("d.cmpprtno_dmd") == F.col("d.nha_dmd")),
        "inner"
    ) \
    .join(
        part_dtls_df.alias("p"),
        (F.col("p.cmpprtno_part") == F.col("o.obprtno")) &
        (F.col("p.nha_part") == F.col("p.cmpprtno_part")),
        "inner"
    ) \
    .select(
        F.col("o.obprno"),
        F.col("o.obprtno"),
        F.col("o.obprtno").alias("nha"),
        F.col("p.vencode_part").alias("vencode"),
        F.col("p.venname_part").alias("venname"),
        F.col("o.is_ltb_avail"),
        F.col("o.ltb_date").alias("ltbdate"),
        F.col("o.ltb_qty").cast("int").alias("ltbqty"),
        F.lit(0).alias("qty_liable_supplier"),
        F.lit(None).cast("int").alias("qty_available_supplier"),
        F.col("o.supplier_date_to_zero").alias("lrc_suppliers_date_to_zero_inventory"),
        F.col("d.lamqoh_dmd").cast("int").alias("lamqoh"),
        F.col("d.open_po_qty_dmd").cast("int").alias("open_po_qty"),
        F.lit(refresh_frequency_days).alias("refresh_frequency"),
        F.lit(None).cast("date").alias("supply_last_updated"),
        F.current_date().alias("last_request_date"),
        F.date_add(F.current_date(), refresh_frequency_days).alias("next_request_date"),
        F.lit("Y").alias("obsupplier"),
        F.col("d.restricted_all_stock_dmd").cast("int").alias("restricted_all_stock")
    ) \
    .distinct()

ob_supplier_df.cache()
ob_supplier_df.count()