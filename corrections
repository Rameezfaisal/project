Cell 5: Write Gold Reporting Table (Snapshot)
​Business Context:
This final step saves the calculated data to the Gold Table (gold_sales_analysis).
​Mode: Overwrite: Since this is a "Reporting Snapshot" that reflects the latest logic and status (scoped to 2 Years + Open), we replace the previous table entirely. This ensures no "stale" records remain if business rules change.
​Optimization: We run a Z-Order optimization on Order and Material columns to ensure Power BI queries are lightning fast.








# --- WRITE TO DELTA LAKE ---
# We use Overwrite mode to replace the old snapshot with the fresh 2-year window.
# 'overwriteSchema' allows you to add new columns in the future without errors.

print(f"Writing Gold Table to: {T_GOLD_ANALYSIS} ...")

df_gold.write \
    .format("delta") \
    .mode("overwrite") \
    .option("overwriteSchema", "true") \
    .saveAsTable(T_GOLD_ANALYSIS)

print("Write completed.")

# --- OPTIMIZE FOR READ SPEED (Power BI) ---
# Z-Ordering clusters similar data together, making filters on Order/Part/Date instant.
spark.sql(f"OPTIMIZE {T_GOLD_ANALYSIS} ZORDER BY (Order, Part, CreationDate)")

print("Optimization completed. Table is ready for Power BI.")
