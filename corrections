# --- CELL 3 UPDATE: AGGREGATE QMEL ---

# ... (Previous code for KNA1, MARA, MBEW remains the same) ...

# FIX: Deduplicate QMEL (Service Notifications)
# SAP allows multiple Notifications per Order. We picked the "Max" QMNUM to keep it 1:1.
# If you need ALL of them, we would use collect_list(), but that keeps the count at 15M.
df_qmel = spark.read.table(S_QMEL).groupBy("aufnr").agg(
    F.max("qmnum").alias("qmnum") 
).withColumnRenamed("aufnr", "qmel_aufnr")

# ... (Rest of Cell 3 logic for VEKP, VBKD, AFKO remains the same) ...










# --- CELL 4 UPDATE: ADD MISSING COLUMNS ---

# ... (Join Logic remains the same - now safe because QMEL is 1:1) ...

df_gold = df_final_logic.select(
    # ... (Keep the previous 74 columns I gave you: OrderStatus, Order, Line, etc.) ...
    
    # --- ADD MISSING COLUMNS HERE ---
    # Look at your SAP View output and add the fields I missed.
    # Examples might include:
    # F.col("k.ort01").alias("City"),
    # F.col("k.land1").alias("Country"),
    # F.col("m.brgew").alias("GrossWeight"),
    # F.col("f.VBAK_BSTNK").alias("PO_Number"),
    
    # ... (Continue until you hit 107 columns) ...
    
    # Audit
    F.current_timestamp().alias("LastRefreshed")
)
