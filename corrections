Cell 6 â€” Update OBPR State for Terminal/Non-Active PRs
Business Purpose:
If iPLM shows a PR-Part is obsolete but its state is no longer in active workflow states (CONFIRMED, IN REVIEW, IN WORK), then update OMAT to reflect the latest OBPR state.







# Source dataset for terminal-state updates
terminal_state_df = (
    iplm_obsolete_df
    .filter(~F.col("state_cd").isin(active_states))  # NOT in active workflow states
    .select(
        F.col("obprno_key").alias("obprno_upd"),
        F.col("obprtno_key").alias("obprtno_upd"),
        F.col("state_cd").alias("new_obpr_state")
    )
    .dropDuplicates()
)

# Perform Delta MERGE update
(
    obprtno_delta.alias("t")
    .merge(
        terminal_state_df.alias("s"),
        "t.obprno = s.obprno_upd AND t.obprtno = s.obprtno_upd"
    )
    .whenMatchedUpdate(set={
        "obpr_state": "s.new_obpr_state",
        "last_modified_on": "current_timestamp()"
    })
    .execute()
)