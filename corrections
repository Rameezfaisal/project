üü¶ Cell 16 ‚Äì MERGE Final Demand & Consumption into Target Table


This cell accumulates results into the final reporting table:
If a Buy Part + NHA already exists
‚Üí add new demand, consumption, stock, and PO quantities
If it does not exist
‚Üí insert a new row
In business terms:
‚ÄúContinuously build up demand, consumption, inventory, and supply metrics for obsolescence analysis.‚Äù







MERGE INTO eng_test.rpt_omat_dmd_consumption_dtls AS a
USING finaldata AS b
ON a.nha = b.nha
AND a.cmpprtno = b.cmpprtno

WHEN MATCHED THEN
  UPDATE SET
    a.mfg_dmd                   = coalesce(a.mfg_dmd, 0) + coalesce(b.mfg_dmd, 0),
    a.mfg_12mnths_consumption   = coalesce(a.mfg_12mnths_consumption, 0) + coalesce(b.mfg_1yrs_cons, 0),
    a.mfg_5yrs_consumption      = coalesce(a.mfg_5yrs_consumption, 0) + coalesce(b.mfg_5yrs_cons, 0),
    a.lamqoh                    = coalesce(a.lamqoh, 0) + coalesce(b.lamqoh, 0),
    a.open_po_qty               = coalesce(a.open_po_qty, 0) + coalesce(b.open_po_qty, 0),
    a.restricted_all_stock      = coalesce(a.restricted_all_stock, 0) + coalesce(b.restricted_all_stock, 0)

WHEN NOT MATCHED THEN
  INSERT (
    cmpprtno,
    nha,
    mfg_sales_dmd,
    mfg_dmd,
    sfg_sales_dmd,
    sfg_dmd,
    mfg_12mnths_consumption,
    lamqoh,
    open_po_qty,
    created_dt,
    mfg_5yrs_consumption,
    sfg_5yrs_consumption,
    restricted_all_stock
  )
  VALUES (
    b.cmpprtno,
    b.nha,
    NULL,
    b.mfg_dmd,
    NULL,
    NULL,
    b.mfg_1yrs_cons,
    b.lamqoh,
    b.open_po_qty,
    current_date,
    b.mfg_5yrs_cons,
    NULL,
    b.restricted_all_stock
  );








SELECT COUNT(*) FROM eng_test.rpt_omat_dmd_consumption_dtls;
SELECT * FROM eng_test.rpt_omat_dmd_consumption_dtls LIMIT 20;

