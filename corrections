​Cell 5: The Main Join Strategy
​Business Context:
This cell reconstructs the central data model. We start with your optimized Sales Order list (613k rows) and attach the master data (Customer names, Material details, Costs, Statuses).
​Critical Logic for Stability:
​Join Types: We strictly follow the SAP logic:
​Inner Joins for KNA1 (Customer), MARA (Material), and PART (Part List). Note: If a Customer or Material is missing in master data, that Sales Order will be dropped (standard SAP behavior).
​Left Joins for everything else (MARC, MBEW, VEKP, QMEL). This ensures that missing optional data (like a tracking number) does not cause the whole Sales Order to disappear.
​Explosion Prevention: Because we pre-aggregated tables like VEKP and QMEL in Cell 4, these joins are now mathematically guaranteed not to multiply your row count.










# Cell 5: The Main Join Execution

# Start with the optimized Sales Order table, aliased as 'p' for readability
df = prst_filtered.alias("p")

# --- Standard Inner Joins (Mandatory Master Data) ---
# Note: Rows with missing Customer or Material master data will be excluded here.

# 1. Join Customer Master (KNA1)
df = df.join(kna1_df, F.col("p.vbak_kunnr") == kna1_df.kunnr, "inner")

# 2. Join Material Master (MARA)
df = df.join(mara_df, F.col("p.vbap_matnr") == mara_df.matnr, "inner")

# 3. Join Part List (PART)
df = df.join(part_df, F.col("p.vbap_matnr") == part_df.part, "inner")

# --- Conditional Left Joins (Optional Data) ---

# 4. Join Plant Data (MARC) - Only if flag was Y
if marc_df:
    df = df.join(marc_df, 
                 (F.col("p.vbap_werks") == marc_df.werks) & 
                 (F.col("p.vbap_matnr") == marc_df.matnr), "left")

# 5. Join Valuation Data (MBEW)
if mbew_2000:
    df = df.join(mbew_2000, F.col("p.vbap_matnr") == mbew_2000.matnr, "left")

if mbew_3120:
    df = df.join(mbew_3120, F.col("p.vbap_matnr") == mbew_3120.matnr, "left")

# 6. Join Handling Units (VEKP)
if vekp_df:
    df = df.join(vekp_df, F.col("p.f1_vbeln") == vekp_df.vpobjkey, "left")

# 7. Join Production Data (AFKO)
if afko_final:
    df = df.join(afko_final, F.col("p.vbak_aufnr") == afko_final.aufnr, "left")

# 8. Join Notifications (QMEL)
if qmel_df:
    df = df.join(qmel_df, F.col("p.vbeln") == qmel_df.aufnr, "left")

# 9. Join Header Incoterms (VBKD)
if hd_inco:
    df = df.join(hd_inco, F.col("p.vbeln") == hd_inco.vbeln, "left")

# 10. Join Line Incoterms (VBKD)
if ln_inco:
    df = df.join(ln_inco, 
                 (F.col("p.vbeln") == ln_inco.vbeln) & 
                 (F.col("p.posnr") == ln_inco.posnr), "left")

# 11. Join Lab Office (T024X) - Always joined via MARA
df = df.join(lab_df, mara_df.labor == lab_df.labor, "left")

# Verification
# The count should be close to 613,852 (or slightly lower if Master Data is missing).
# It should DEFINITELY NOT be millions higher.
print("Join Complete.")
print(f"Post-Join Row Count: {df.count()}")
