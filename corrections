ðŸŸ¦ Cell 14 â€“ Calculate Open Purchase Order Quantity per NHA

This step calculates open purchase order quantity per NHA:
Measures incoming supply not yet received
Excludes:
Inactive / deleted / completed POs
Stock transfers, subcontracting, special item categories
Artificial year-end due dates (04-01, 12-31)
Rolled up from Order BOM â†’ NHA
In business terms:
â€œWhat quantity is still expected to arrive from suppliers for each NHA?â€





poqty_df = (
    po_hstry_df.alias("a")
    .join(
        ekpo_df.alias("b"),
        (F.col("a.ebeln") == F.col("b.ebeln")) &
        (F.col("a.ebelp") == F.col("b.ebelp")),
        "inner"
    )
    .join(
        newlist_df.alias("c"),
        F.col("a.matnr") == F.col("c.odrbom"),
        "inner"
    )
    .filter(
        (F.substring(F.col("a.due_dt"), -5, 5) != "04-01") &
        (F.substring(F.col("a.due_dt"), -5, 5) != "12-31") &
        (F.col("a.status") != "INACT") &
        (F.trim(F.col("a.matnr")) != "") &
        (F.trim(F.col("a.loekz")) == "") &
        (F.col("a.aussl") != "U3") &
        (F.col("a.bsart") != "UB") &
        (F.col("a.elikz") != "X") &
        (~F.col("b.pstyp").isin("7", "9"))
    )
    .groupBy(
        F.col("c.nha").alias("nha")
    )
    .agg(
        F.sum(
            F.col("a.menge") - F.col("a.wemng")
        ).alias("open_po_qty")
    )
)

# Register for final assembly
poqty_df.createOrReplaceTempView("poqty")





poqty_df.count()
poqty_df.show(10, truncate=False)







Cell 15 â€“ Build FINALDATA (Demand + Consumption + Inventory + Supply)


Business purpose
This step creates the final analytical dataset per Buy Part + NHA:
It combines:
Demand (forecast)
Consumption (1-year & 5-year actuals)
Inventory (QOH + restricted stock)
Supply (open PO quantity)
And filters out:
NHAs with no demand and no consumption activity
In business terms:
â€œOnly keep NHAs that actually matter for obsolescence decisions.â€





finaldata_df = (
    nhalist2_df.alias("a")
    .join(
        odrbom_1yr_cons_df.alias("b"),
        F.col("a.nha") == F.col("b.nha"),
        "left"
    )
    .join(
        qoh_df.alias("c"),
        F.col("a.nha") == F.col("c.nha"),
        "left"
    )
    .join(
        poqty_df.alias("d"),
        F.col("a.nha") == F.col("d.nha"),
        "left"
    )
    .select(
        F.col("a.cmpprtno").alias("cmpprtno"),
        F.col("a.nha").alias("nha"),

        F.col("b.mfg_dmd").alias("mfg_dmd"),
        F.col("b.mfg_5yrs_cons").alias("mfg_5yrs_cons"),
        F.col("b.mfg_1yrs_cons").alias("mfg_1yrs_cons"),

        F.col("c.lamqoh").alias("lamqoh"),
        F.col("d.open_po_qty").alias("open_po_qty"),
        F.col("c.restricted_all_stock").alias("restricted_all_stock")
    )
    .filter(
        (
            F.abs(F.coalesce(F.col("mfg_5yrs_cons"), F.lit(0))) +
            F.abs(F.coalesce(F.col("mfg_dmd"), F.lit(0))) +
            F.abs(F.coalesce(F.col("mfg_1yrs_cons"), F.lit(0)))
        ) > 0
    )
)

# Register for MERGE step
finaldata_df.createOrReplaceTempView("finaldata")






finaldata_df.count()
finaldata_df.show(10, truncate=False)

