Cell 8 — Build RLTDPRS (Detect Parts in Multiple Active OBPRs)
Business Purpose:
Identify parts that appear in more than one active OB Problem Report.
This helps flag duplicate investigations and links related PR numbers.








active_iplm_df = (
    iplm_obsolete_df
    .filter(
        (F.col("state_cd").isin(active_states)) |
        (F.col("disposition_cd").isin(active_dispositions))
    )
    .select(
        "obprno_key",
        "obprtno_key"
    )
    .dropDuplicates()
)





omat_keys_df = (
    omat_view_df_raw
    .select(
        F.col("obprno").alias("omat_obprno"),
        F.col("obprtno").alias("omat_obprtno")
    )
    .dropDuplicates()
)

duplicate_pairs_df = (
    active_iplm_df.alias("a")
    .join(
        omat_keys_df.alias("b"),
        (F.col("a.obprtno_key") == F.col("b.omat_obprtno")) &   # ❌ wait wrong col?
        (F.col("a.obprno_key") != F.col("b.omat_obprno")),      # different PR
        "inner"
    )
    .select(
        F.col("a.obprtno_key").alias("part_name_dup"),
        F.col("a.obprno_key").alias("related_pr")
    )
    .dropDuplicates()
)






rltdprs_df = (
    duplicate_pairs_df
    .groupBy("part_name_dup")
    .agg(
        F.concat_ws(",", F.collect_set("related_pr")).alias("openprs"),
        F.lit("Yes").alias("duplicate_pr_flag")
    )
)






rltdprs_df.createOrReplaceTempView("vw_rltdprs")
