Cell 10 — OB PR Supplier (Supplier Who Raised the Obsolescence Request)
What this step does in business terms
Some parts become obsolete because a supplier officially reported the problem in IPLM (Problem Reports).
That supplier:
Is directly involved
Usually holds last-time-buy stock
Is often the best contact for OMAT
This step answers:
“Which supplier raised the Obsolete Component PR for this NHA?”
SAP uses this supplier as a high-priority fallback.







# filter valid OB PRs
df_obpr = (
    df_iplm
    .filter(F.col("part_name_cd") != "NA")
    .filter(F.col("state_cd") != "CLOSED")
    .filter(
        (F.col("state_cd").isin("CONFIRMED", "IN REVIEW", "IN WORK")) |
        (F.col("disposition_cd").isin("CONFIRMED", "DEFER"))
    )
    .filter(F.col("reason_cd") == "OBSOLETE COMPONENT")
)

# format supplier code to 10 chars
df_obpr = (
    df_obpr
    .withColumn("suppcd_pr", F.lpad(F.col("supplier_code_cd"), 10, "0"))
)

# join supplier name
df_obpr_named = (
    df_obpr
    .join(df_lfa1, df_obpr.suppcd_pr == df_lfa1.lifnr_cd, "left")
    .select(
        F.col("part_name_cd").alias("nha"),
        F.col("suppcd_pr"),
        F.col("name1_cd").alias("suppname_pr")
    )
)

# attach PR supplier to main dataset
df_stage6 = (
    spark.table("stage5_with_po")
    .join(df_obpr_named, "nha", "left")
)

df_stage6.createOrReplaceTempView("stage6_with_pr")