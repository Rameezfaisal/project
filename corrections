Cell 10 â€” Build DUPLICATEPR (Latest PR per Part)
Business Purpose:
For parts that appear in multiple PRs, we must determine which PR is the most recent (by submitted date).
Later, we will pull LTB and supplier depletion info only from that latest PR.
This ensures OMAT reflects the most up-to-date commercial decision.





Identify Parts with Duplicate PRs in OMAT



duplicate_parts_df = (
    spark.table(tgt_obprtno_dtls_tbl)
    .filter(F.col("reltd_ob_pr").isNotNull() & (F.length(F.col("reltd_ob_pr")) > 0))
    .select(
        F.col("obprtno").alias("dup_part_key")
    )
    .dropDuplicates()
)





active_iplm_for_dup_df = (
    iplm_obsolete_df
    .filter(
        (F.col("state_cd") != closed_state) &
        (
            F.col("state_cd").isin(active_states) |
            F.col("disposition_cd").isin(active_dispositions)
        )
    )
    .select(
        F.col("obprtno_key").alias("dup_part_key"),
        "submitted_date"
    )
)




Get Latest Submitted Date per Part



duplicatepr_df = (
    duplicate_parts_df.alias("d")
    .join(
        active_iplm_for_dup_df.alias("i"),
        "dup_part_key",
        "inner"
    )
    .groupBy("dup_part_key")
    .agg(
        F.max("submitted_date").alias("latest_submitted_date")
    )
)

duplicatepr_df.createOrReplaceTempView("vw_duplicatepr")