Implements SAP Step-4:
Calculates total spares consumption over the last 3 years from
ZT_CSBG_SPARES_DELIVERIES, filtered by order type, source doc, and GI date, grouped by CMPPRTNO + NHA.




sprs3 = (
    spares
    .join(nhalist, spares.material == nhalist.nha, "inner")
    .filter(
        (spares.source_doc != "STO") &
        (spares.order_type.isin("TA","ZCON","ZO09","ZO04","ZSD","ZSO","ZFO","ZUP")) &
        (spares.actual_gi > F.date_sub(F.current_date(), 365*3))
    )
    .groupBy(
        nhalist.cmpprtno.alias("cmpprtno_cd"),
        spares.material.alias("nha_cd")
    )
    .agg(
        F.sum(spares.qty_shipped).alias("sprs_3yrs_consumption")
    )
)