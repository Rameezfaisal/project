â€” 5-Year & 1-Year Consumption Rollups


From the transaction history, calculate how much each NHA has consumed in the last 5 years and the last 1 year.
These numbers are later used to judge usage vs forecast vs stock.



# Read consumption table
cons_tbl = spark.table(tgt_odrbom_cons)

# 5-year consumption (already filtered to 5 years when created)
mfg_5yr = (
    cons_tbl
    .groupBy("nha")
    .agg(F.sum("menge").cast("int").alias("mfg_5yrs_cons"))
)

# 1-year consumption
mfg_1yr = (
    cons_tbl
    .filter(
        (F.col("cons_date") > one_year_ago) &
        (F.col("cons_date") < today)
    )
    .groupBy("nha")
    .agg(F.sum("menge").cast("int").alias("mfg_1yrs_cons"))
)