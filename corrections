Cell 5: VBEP Cumulative Logic & First Schedule Line
​Business Context:
This cell handles the "Schedule Lines" (VBEP), which define when and how much quantity is confirmed.
​Expected Qty Cumulative: Calculates the running total of confirmed quantities (BMENG) for each line item.
​Optimization: The SAP code used a slow "Self-Join" (t1.ETENR >= t2.ETENR). In Spark, we replace this with a highly efficient Window Function (Running Sum).
​First Date (H): Captures the EDATU (Schedule Line Date) from the very first schedule line (ETENR = '0001') to establish the baseline date.





# --- 1. VBEP CUMULATIVE LOGIC ---
# Filter VBEP first as per SAP requirements (BMENG > 0)
df_vbep_filtered = df_vbep.filter(F.col("bmeng") > 0)

# Define Window: Partition by Order/Item, Order by Schedule Line Number (ETENR)
w_cum = Window.partitionBy("vbeln", "posnr").orderBy("etenr").rowsBetween(Window.unboundedPreceding, Window.currentRow)

ds_vbep_cum = df_vbep_filtered.select(
    "vbeln", 
    "posnr", 
    "etenr", 
    "bmeng",
    "edatu",
    "lifsp",
    "mbdat"
).withColumn(
    "expectedqtycumulative_cd", 
    F.sum("bmeng").over(w_cum) # Running Sum replacing the SAP Self-Join
)

# --- 2. H LOGIC (First Schedule Line Date) ---
# SAP: SELECT ... WHERE ETENR = '0001'
ds_h = df_vbep.filter(F.col("etenr") == "0001").select(
    F.col("vbeln").alias("h_vbeln"),
    F.col("posnr").alias("h_posnr"),
    F.col("edatu").alias("vbep_h_edatu_cd")
)
