# --- CELL 5: WRITE & OPTIMIZE (FINAL) ---

# 1. Update Table Properties (CRITICAL FOR 107 COLUMNS)
# We set the limit to 200 so Spark indexes ALL your columns, not just the first 32.
# This ensures filters on 'Region', 'Part', or 'Flag' are fast in Power BI.
spark.sql(f"""
    ALTER TABLE {T_GOLD_ANALYSIS} 
    SET TBLPROPERTIES ('delta.dataSkippingNumIndexedCols' = '200')
""")

# 2. Run Optimize
# Now that the property is set, Z-ORDER will successfully cluster your data.
# This might take 5-10 minutes but is worth it for user query speed.
print(f"Starting Z-Order Optimization on {T_GOLD_ANALYSIS}...")
spark.sql(f"OPTIMIZE {T_GOLD_ANALYSIS} ZORDER BY (Order, Part, CreationDate)")

print("Optimization completed. Table is ready for Power BI.")
