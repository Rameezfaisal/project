â€” Cell 4: Implement PARSE_20 + build filter tables
Business meaning:
SAP passes comma-separated Sales Orgs and Order Types into the procedure and converts them into tables using PARSE_20.
We replicate that so filtering works exactly the same in Fabric.








def parse_20(csv_string):
    return (
        spark
        .createDataFrame([(csv_string,)], ["raw"])
        .select(F.explode(F.split(F.regexp_replace("raw","'",""), ",")))
        .select(F.trim(F.col("col")).alias("object"))
        .filter(F.col("object") != "")
    )




input_sales_org  = parse_20(ip_sales_org)
input_order_type = parse_20(ip_order_type)

input_sales_org.createOrReplaceTempView("input_sales_org")
input_order_type.createOrReplaceTempView("input_order_type")





marc_flag  = ip_data_pruning_flag[0]
mbew_flag  = ip_data_pruning_flag[1]
vekp_flag  = ip_data_pruning_flag[2]
vbkd_flag  = ip_data_pruning_flag[3]
afvc_flag  = ip_data_pruning_flag[4]
qmel_flag  = ip_data_pruning_flag[5]
t024x_flag = ip_data_pruning_flag[6]




prst_filt = (
    prst
    .join(input_sales_org,
          (prst["vbak_vkorg"] == input_sales_org["object"]) |
          (input_sales_org["object"] == F.lit("ALL")),
          "inner")
    .join(input_order_type,
          (prst["vbak_auart"] == input_order_type["object"]) |
          (input_order_type["object"] == F.lit("ALL")),
          "inner")
)




