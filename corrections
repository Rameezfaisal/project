ðŸ“Œ Cell 4 â€” AUSP attributes (Critical & CE)
This cell extracts two material characteristics from the SAP AUSP table and prepares them for joining to NHA parts:
critical
From ATINN = '0000006193'
â†’ This is the SAP classification field that marks whether a part is Critical
ce
From ATINN = '0000015276' and ATWRT = 'Y'
â†’ This identifies parts that are CE-qualified
We convert these into two small lookup DataFrames keyed by NHA (objek), so they can be left-joined later when building OMAT_PART_DTLS.
In short:
Cell-4 translates SAP classification flags into Fabric-joinable attributes for each NHA.









Here are clean, short markdown briefs you can paste into your notebook for Cell 5 â†’ Cell 8.
ðŸ“Œ Cell 5 â€” Base join graph
This cell joins together all master and reference data needed to build OMAT part records.
It links each NHA from DMD to:
Selected supplier & plant (from Supplier-by-Plant output)
Material description (MAKT)
Plant data (MARC)
Valuation & cost (MBEW)
Critical & CE flags (AUSP)
Supplier classification hierarchy (ZSUPPLIER_XREF + ZSUPP_CODE_MSTR)
In short:
This creates a single wide dataset containing everything SAP needs to build OMAT_PART_DTLS.
ðŸ“Œ Cell 6 â€” MRP supplier eligibility
This cell implements SAP 107767 logic to decide whether a part has a valid MRP supplier.
It checks if the NHA has a supplier in any of the MRP plants:
Copy code

2000, 1900, 3120, 1050, 1060, 1090
If at least one exists â†’ mrp_supplier = 1, else 0.
In short:
This determines whether the part is MRP-sourced in OMAT.
ðŸ“Œ Cell 7 â€” Final projection
This cell selects and formats exactly the columns required by
eng_test.rpt_omat_part_dtls.
It outputs:
Part identifiers (CMPPRTNO, NHA)
Description, supplier, lead time, costs
Critical & CE flags
Commodity, SMG group, head, SBM
MRP flag
PO supplier details
In short:
This converts the wide joined dataset into the final OMAT schema.
ðŸ“Œ Cell 8 â€” Delta insert
This cell inserts the prepared records into:
Copy code

eng_test.rpt_omat_part_dtls
using an explicit column list to ensure:
ANSI safety
Delta schema enforcement
No positional insert risks
In short:
This writes the final OMAT Part master into Fabric.






final_part = base.select(
    dmd.cmpprtno,
    dmd.nha,
    makt.maktx.alias("description"),
    sup.omat_selected_suppliercd.alias("vencode"),
    sup.omat_selected_supplier.alias("venname"),
    marc.plifz.cast("int").alias("lead_time"),
    mbew.stprs.cast("double").alias("std_cost"),
    mbew.zplp2.cast("double").alias("curr_cost"),
    critical.critical,
    ce.ce,
    F.col("g.zdesc").alias("commodity"),
    F.col("h.zdesc").alias("smg_group"),
    F.col("i.zdesc").alias("smg_head"),
    F.col("j.zdesc").alias("sbm"),
    F.when(mrp_flag, F.lit(1)).otherwise(F.lit(0)).alias("mrp_supplier"),
    sup.suppcd_po1.alias("po_supp_code"),
    sup.suppname_po1.alias("po_supp_name")
)








final_part.createOrReplaceTempView("final_part")

spark.sql(f"""
INSERT INTO {tgt_part}
(ce,cmpprtno,commodity,critical,curr_cost,description,lead_time,mrp_supplier,
 nha,po_supp_code,po_supp_name,sbm,smg_group,smg_head,std_cost,vencode,venname)
SELECT
 ce,cmpprtno,commodity,critical,curr_cost,description,lead_time,mrp_supplier,
 nha,po_supp_code,po_supp_name,sbm,smg_group,smg_head,std_cost,vencode,venname
FROM final_part
""")

