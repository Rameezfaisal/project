df_iplm_prp = spark.read.table(tbl_iplm_prp)
df_omat_obprt_src = spark.read.table(tbl_omat_obprt_src)



df_iplm_prp.createOrReplaceTempView("iplm_prp")
df_omat_obprt_src.createOrReplaceTempView("omat_obprt_src")



spark.sql("""
CREATE OR REPLACE TEMP VIEW obprdtls AS
SELECT
    ROW_NUMBER() OVER (PARTITION BY ob_prno ORDER BY ob_prtno) AS id,
    ob_prno,
    ob_prtno,
    part_status,
    obpr_state,
    is_ltb_avail,
    ltb_date,
    0 AS ltb_qty,
    CAST(NULL AS STRING) AS reltd_ob_prs,
    'No' AS duplicate_pr_flag,
    'No' AS is_obprt_processed,
    supplier_date_to_zero
FROM (
    SELECT
        name        AS ob_prno,
        part_name   AS ob_prtno,
        mstae       AS part_status,
        state       AS obpr_state,
        disposition,
        reason,
        is_the_last_time_buy_available AS is_ltb_avail,
        ob_last_buy_date               AS ltb_date,
        lrc_suppliers_date_to_zero_inventory AS supplier_date_to_zero
    FROM iplm_prp
) base
JOIN obprlst o
  ON base.ob_prno = o.ob_prno
LEFT JOIN omat_obprt_src
  ON base.ob_prno  = obprno
 AND base.ob_prtno = obprtno
WHERE base.ob_prtno <> 'NA'
  AND UPPER(base.obpr_state) <> 'CLOSED'
  AND (
        UPPER(base.obpr_state) IN ('CONFIRMED','IN REVIEW','IN WORK')
        OR UPPER(disposition) IN ('CONFIRMED','DEFER')
      )
  AND UPPER(reason) = 'OBSOLETE COMPONENT'
  AND obprno IS NULL
""")