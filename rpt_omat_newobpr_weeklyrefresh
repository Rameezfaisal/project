# Source tables (FULL paths)
tbl_iplm_prp       = "prd.IPLM/CV_IPLM_PROBLEM_REPORT_PART"
tbl_omat_obprt_src = "prd.gops.OMAT/CV_OMAT_OBPRTNO_DTLS"

# Target tables (FULL paths)
tbl_omat_obprt_tgt = "w_omat.omat_obprtno_dtls"
tbl_omat_log_tgt   = "w_omat.omat_log_dtls"

weekly_limit = 10




from pyspark.sql import functions as F
from pyspark.sql.window import Window

df_iplm = spark.read.table(tbl_iplm_prp)
df_omat_src = spark.read.table(tbl_omat_obprt_src)





obprlst_df = (
    df_iplm
    .filter(F.col("part_name") != "NA")
    .filter(F.upper("state") != "CLOSED")
    .filter(
        (F.upper("state").isin("CONFIRMED","IN REVIEW","IN WORK")) |
        (F.upper("disposition").isin("CONFIRMED","DEFER"))
    )
    .filter(F.upper("reason") == "OBSOLETE COMPONENT")
    .join(
        df_omat_src,
        (df_iplm.name == df_omat_src.obprno) &
        (df_iplm.part_name == df_omat_src.obprtno),
        "left"
    )
    .filter(df_omat_src.obprno.isNull())
    .select("name")
    .distinct()
    .withColumn("id", F.dense_rank().over(Window.orderBy("name")))
    .limit(weekly_limit)
    .withColumnRenamed("name", "ob_prno")
)

obprlst_df.createOrReplaceTempView("obprlst")