Your “UNION logic” filter is wrong (missing ORs).
In final = base.filter(...) you intended (cmpprtno=nha) OR (any_metric>0) but your code has line continuations without | operators, so the second block is not OR’ed as SAP UNION condition; it won’t match SAP row inclusion. 


MAKT join is not SAP-faithful (missing spras='E' and can duplicate).
SAP joins CV_MAKT but in the MFG consumption steps it groups by C.MAKTX and doesn’t filter SPRAS, so the join can multiply rows if multiple languages exist; your join is mseg.matnr == makt.matnr with no language filter and no distinct, which can change consumption sums compared to SAP depending on MAKT contents.


MFG time window is now too strict vs SAP for 3Y/12M.
You added a global filter mkpf.bldat > today-5y AND mkpf.bldat < today before aggregation. In SAP, only the 3Y/12M measures have those narrower windows, but the base query still includes records back 3Y/12M respectively; your global 5Y filter is ok for 5Y, but you also changed the lower bound behavior for 3Y/12M when data older than 5Y isn’t needed—this is fine; the bigger issue is you removed SAP’s D.BLDAT < CURRENT_DATE in each metric check but you did include < today globally, so that part is aligned.
