Cell 8: Final Output (Display or Write)
​Business Context:
This final step materializes the "Consumption View." In SAP, this would be the result set returned to the user or reporting tool. In Fabric, we typically:
​Display: For immediate validation in the notebook.
​Write: Save it as a Delta Table (e.g., rpt_sales_order_optimized) for Power BI or downstream consumption.






# CELL 8: Display & Materialize Final Report

# 1. Validation: Show a sample of the data
# display(df_output.limit(100))

# 2. Write to Delta Table (Consumption Layer)
# Replace 'lakehouse.rpt_sales_order_optimized' with your actual target table name
target_report_table = "lakehouse.rpt_sales_order_optimized"

df_output.write \
    .format("delta") \
    .mode("overwrite") \
    .option("overwriteSchema", "true") \
    .saveAsTable(target_report_table)

print(f"Successfully wrote {df_output.count()} rows to {target_report_table}")










Cell 4: Master Data Preparation (Lookup Tables)
​Business Context:
This step prepares the "reference data" needed to enrich the sales orders. Instead of joining massive raw tables directly, we pre-process them to select only the necessary business fields (like costs, incoterms, and service activities). This ensures the final report is fast and contains meaningful descriptions rather than just codes.
​Key Actions Performed:
​Standard Cost Retrieval: Fetches the standard price (STPRS) for materials from two specific valuation areas (2000 and 3120) to calculate accurate profit margins.
​Service Order Details: Extracts activity types (LARNT) for service-related orders to categorize the type of work being performed.
​Shipping & Tracking: Aggregates tracking numbers (EXIDV2) so logistics teams can trace shipments.
​Incoterms Logic: Separates shipping terms (e.g., FOB, CIF) into "Header" level (applies to whole order) and "Line" level (applies to specific items) to ensure the correct terms are used for pricing.
​Lab Office Decoding: Translates technical Lab codes (e.g., 023) into readable descriptions (e.g., "SPIN", "DEP") for reporting.