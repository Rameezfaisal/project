# DON'T repartition before write - it will slow things down
# The issue is you'd be repartitioning BEFORE reordering columns

# INSTEAD: Add these configs at the START of your notebook (In[6])
spark.conf.set("spark.sql.shuffle.partitions", "400")
spark.conf.set("spark.sql.adaptive.enabled", "true")
spark.conf.set("spark.sql.adaptive.coalescePartitions.enabled", "true")

# Then in your write cell, ONLY add repartition if the write is still slow:
final_ordered = final.select(...)

# Optional: Only if write is still slow after first run
# final_ordered = final_ordered.repartition(200)

final_ordered.write.mode("append").