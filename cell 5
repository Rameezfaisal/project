ðŸŸ¦ Cell 7 â€“ Build NEWLIST (Order BOM â†” NHA Mapping)


This step establishes the core relationship between Order BOMs and NHAs that:
Drives consumption calculations
Drives QOH and PO quantity rollups
Acts as the bridge dataset for all downstream joins
In business terms:
â€œFor every NHA in scope, identify all contributing Order BOM materials.â€




newlist_df = (
    spark.read.table("eng_test.rpt_omat_odrbom_dmd_dtls")
    .select(
        F.col("odrbom").alias("odrbom"),
        F.col("nha").alias("nha")
    )
    .distinct()
)

# Register as temp view to mirror SAP temp table
newlist_df.createOrReplaceTempView("newlist")









ðŸŸ¦ Cell 8 â€“ Build & Insert Order-BOM Consumption Details (261 / 262)


This step calculates actual material consumption for Order BOMs:
Uses goods issue / reversal movements (261 / 262)
Applies sign correction based on debit/credit (SHKZG)
Restricts data to last 5 years
Ties consumption back to NHA via Order BOM
In business terms:
â€œHow much material was actually consumed for manufacturing over the last 5 years?â€







odrbom_cons_df = (
    newlist_df.alias("a")
    .join(
        mseg_df.alias("b"),
        F.col("b.matnr") == F.col("a.odrbom"),
        "inner"
    )
    .join(
        makt_df.alias("c"),
        F.col("c.matnr") == F.col("b.matnr"),
        "inner"
    )
    .join(
        mkpf_df.alias("d"),
        F.col("b.mblnr") == F.col("d.mblnr"),
        "inner"
    )
    .filter(
        F.col("b.bwart").isin("261", "262")
        & (F.col("d.bldat") > F.date_add(F.current_date(), -five_year_days))
        & (F.col("d.bldat") < F.current_date())
        & (F.col("b.cpudt_mkpf") > F.date_add(F.current_date(), -five_year_days))
    )
    .select(
        F.col("d.bldat").alias("cons_date"),
        F.when(F.col("b.shkzg") == "S", -1 * F.col("b.menge"))
         .otherwise(F.col("b.menge"))
         .cast("decimal(13,3)")
         .alias("menge"),
        F.col("a.nha").alias("nha"),
        F.col("a.odrbom").alias("odrbom")
    )
    .filter(F.col("menge").isNotNull())   # Delta NOT NULL safety
    .distinct()
)





(
    odrbom_cons_df
    .select("cons_date", "menge", "nha", "odrbom")
    .write
    .mode("append")
    .saveAsTable("eng_test.rpt_omat_odrbom_cons_dtls")
)



