Cell 4 — NHAMAINLIST (Core population of interest)
Business meaning:
This cell identifies “Make NHA parts that are currently active in OB PR”.






Cell 5 — NHALIST
Business meaning:
Extracts the unique list of NHA materials from NHAMAINLIST.
This is the master NHA population on which:
Manufacturing consumption
Manufacturing demand
Spares demand
Spares consumption
will be calculated.




Cell 6 — Manufacturing 5 Years Consumption (df_mfg_5yrs)
Business intent (as per SAP logic):
Compute total manufacturing consumption of each NHA over the last 5 years, considering:
Goods issues/receipts (261/262)
Only relevant plants (<2001 or 3120)
Adjusted for debit/credit (SHKZG logic)






Cell 7 — Manufacturing Weekly Demand (26 Weeks)
Business meaning:
Calculates planned manufacturing demand for each NHA over the next 26 weeks, based on:
MDKP + MDTB planning data
Only relevant plants
Only relevant demand categories (AR, SB)
Only within the 26-week window (DT1WK to DT26WK)
This is your forward-looking manufacturing demand signal.






Cell 8 — Spares Weekly Demand (26 Weeks)
Business meaning:
Calculates open spares sales order demand for each NHA over the next 26 weeks, considering:
Only Sales Orders (OrderGroup = SO)
Excluding closed orders
Only relevant order types (TA, ZCON, ZUP, etc.)
Only deliveries due within the 26-week window
This is your forward-looking spares demand signal.







Cell 9 — Spares 5 Years Consumption (Fixed)
What this cell does (business meaning)
This step answers:
“How much of each NHA was actually consumed as spare parts in the last 5 years?”
It uses actual goods issue from ZT_CSBG_SPARES_DELIVERIES, keeping only:
Relevant order types (TA, ZCON, ZUP, etc.)
Non-STO deliveries
Shipments in the last 5 years
Positive shipped quantities
This is your historical spares consumption signal.








df_sprs_cons = (
    df_spares.alias("a")
    .join(df_nhalist.alias("b"),
          F.col("b.nha_cd") == F.col("a.material_cd"),
          "inner")
    .filter(
        (F.col("a.source_doc") != "STO") &
        (F.col("a.order_type").isin("TA","ZCON","ZO09","ZO04","ZSD","ZSO","ZFO","ZUP")) &
        (F.col("a.actual_gi") > F.date_sub(F.current_date(), 365*5))
    )
    .groupBy(F.col("a.material_cd"))
    .agg(
        F.sum(F.col("a.qty_shipped")).alias("sprs_5yrs_consumption_cd")
    )
    .filter(F.col("sprs_5yrs_consumption_cd") > 0)
)

df_nhalist_sprscons = (
    df_nhalist_sprsdmd.alias("a")
    .join(df_sprs_cons.alias("b"),
          F.col("b.material_cd") == F.col("a.nha_cd"),
          "left")
    .select(
        "a.cmpprtno_cd",
        "a.nha_cd",
        "a.mfg_5yrs_consumption_cd",
        "a.mfg_dmd_cd",
        "a.sprs_dmd_cd",
        F.col("b.sprs_5yrs_consumption_cd")
    )
)

df_nhalist_sprscons.createOrReplaceTempView("nhalist_sprscons_vw")



