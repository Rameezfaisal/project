# --- CELL 3 UPDATE: AGGREGATE QMEL ---

# ... (Previous code for KNA1, MARA, MBEW remains the same) ...

# FIX: Deduplicate QMEL (Service Notifications)
# SAP allows multiple Notifications per Order. We picked the "Max" QMNUM to keep it 1:1.
# If you need ALL of them, we would use collect_list(), but that keeps the count at 15M.
df_qmel = spark.read.table(S_QMEL).groupBy("aufnr").agg(
    F.max("qmnum").alias("qmnum") 
).withColumnRenamed("aufnr", "qmel_aufnr")

# ... (Rest of Cell 3 logic for VEKP, VBKD, AFKO remains the same) ...
