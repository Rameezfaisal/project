# OB parts that still need explosion (not obsolete)
df_active_ob = (
    df_obprt
    .filter(
        (F.col("obprno") == i_prno) &
        (~F.col("part_status").isin("ob", "os", "op"))
    )
    .select(
        F.col("obprtno").alias("obprtno")
    )
    .distinct()
)

# Safety check – no nulls (Delta NOT NULL guard)
df_active_ob = df_active_ob.filter(F.col("obprtno").isNotNull())

# Register for later looping
df_active_ob.createOrReplaceTempView("df_active_ob")








Cell 4 handles this SAP logic:
“If the OB part is already Obsolete (OB / OS / OP), don’t explode it — just insert the part itself as its own NHA.”
In simple words:
For the given i_prno:
Find component parts that are already obsolete
For each such part:
Treat the part as its own NHA
Insert one row into OMAT_OBPN_NHA_DTLS
Set:
level = 1
cmpprtno = nha = childpn = part
bomqpa = cmpqpa = 1
Insert only if it does not already exist in NHA table
This matches the first SAP loop exactly.
