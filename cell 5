CELL 4 — Insert New MAKE-NHAs (Delta-safe, Fabric-correct)
Business purpose
Register newly detected MAKE-NHAs for OB parent parts so that their demand & consumption can be calculated downstream.
This cell: • Finds new NHAs
• Aggregates CMPQPA
• Inserts into rpt_omat_obpn_make_nha_dtls





Cell 5 — Build MKNHA (Unprocessed MAKE-NHAs)
Business purpose
This is the driving dataset of the entire procedure.
It represents:
“Which OB Parent → NHA combinations are new and still need demand & consumption to be calculated.”







mknha = (
    spark.read.table(make_nha_target_path)
    .filter(F.col("isprocessed") == "N")
    .select(
        F.col("cmpprtno").alias("cmpprtno"),
        F.col("nha").alias("nha")
    )
    .dropDuplicates()
)

mknha.cache()